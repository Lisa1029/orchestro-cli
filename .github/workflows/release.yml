name: Release and Publish

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string

env:
  FORCE_COLOR: 1

jobs:
  # Create GitHub Release
  release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Build package
        run: python -m build

      - name: Extract release notes
        id: extract-notes
        run: |
          # Extract version from tag or input
          VERSION="${{ github.event.inputs.version || github.ref_name }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # Create release notes
          echo "## What's Changed in $VERSION" > release_notes.md
          echo "" >> release_notes.md

          # Get commits since last tag
          PREVIOUS_TAG=$(git describe --abbrev=0 --tags HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREVIOUS_TAG" ]; then
            git log $PREVIOUS_TAG..HEAD --pretty=format:"- %s (%h)" >> release_notes.md
          else
            git log --pretty=format:"- %s (%h)" --max-count=20 >> release_notes.md
          fi

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.extract-notes.outputs.version }}
          name: Release ${{ steps.extract-notes.outputs.version }}
          body_path: release_notes.md
          files: |
            dist/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Post to Discord
      - name: Post to Discord
        if: vars.DISCORD_WEBHOOK != ''
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: "ðŸš€ New Release: ${{ steps.extract-notes.outputs.version }}"
          description: |
            **Orchestro CLI** has a new release!

            [View Release](https://github.com/${{ github.repository }}/releases/tag/${{ steps.extract-notes.outputs.version }})

            Check out what's new in this version!
          color: 0x00ff00
          username: "Orchestro Release Bot"

      # Create Job Summary
      - name: Job Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ðŸš€ Release ${{ steps.extract-notes.outputs.version }} Published!

          ## What happened?
          - âœ… Changelog generated
          - âœ… GitHub release created
          - ${{ vars.DISCORD_WEBHOOK != '' && 'âœ…' || 'â­ï¸' }} Discord notification ${{ vars.DISCORD_WEBHOOK != '' && 'sent' || 'skipped (no webhook)' }}
          - â­ï¸ PyPI publish will run in separate job

          ## Next Steps
          - Share the release on social media
          - Update documentation if needed
          - Monitor for issues
          EOF

  # Publish to PyPI
  publish-pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: release
    environment: pypi
    permissions:
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Build package
        run: python -m build

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          skip-existing: true
          verbose: true
