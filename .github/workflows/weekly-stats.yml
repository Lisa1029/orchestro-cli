name: Weekly Stats Report

on:
  schedule:
    - cron: '0 9 * * 1'  # Every Monday at 9am UTC
  workflow_dispatch:  # Manual trigger

jobs:
  stats:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v3

      # 1. Fetch GitHub Stats
      - name: Get GitHub Stats
        id: github_stats
        uses: actions/github-script@v7
        with:
          script: |
            const repo = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo
            });

            // Get issues from last week
            const lastWeek = new Date(Date.now() - 7*24*60*60*1000).toISOString();
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              since: lastWeek
            });

            // Get PRs from last week
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              sort: 'created',
              direction: 'desc'
            });

            const recentPrs = prs.data.filter(pr =>
              new Date(pr.created_at) > new Date(lastWeek)
            );

            const stats = {
              stars: repo.data.stargazers_count,
              forks: repo.data.forks_count,
              watchers: repo.data.watchers_count,
              open_issues: repo.data.open_issues_count,
              issues_opened: issues.data.filter(i => !i.pull_request).length,
              prs_opened: recentPrs.length,
              prs_merged: recentPrs.filter(pr => pr.merged_at).length
            };

            core.setOutput('stats', JSON.stringify(stats));
            return stats;

      # 2. Fetch PyPI Stats
      - name: Get PyPI Downloads
        id: pypi_stats
        continue-on-error: true
        run: |
          # Get PyPI stats (if package published)
          DOWNLOADS=$(curl -s "https://pypistats.org/api/packages/orchestro-cli/recent" | jq -r '.data.last_week // 0')
          echo "downloads=$DOWNLOADS" >> $GITHUB_OUTPUT

      # 3. Create Report
      - name: Create Report
        id: report
        env:
          STATS: ${{ steps.github_stats.outputs.stats }}
          DOWNLOADS: ${{ steps.pypi_stats.outputs.downloads }}
        run: |
          STATS_JSON='${{ steps.github_stats.outputs.stats }}'
          STARS=$(echo $STATS_JSON | jq -r '.stars')
          FORKS=$(echo $STATS_JSON | jq -r '.forks')
          ISSUES=$(echo $STATS_JSON | jq -r '.issues_opened')
          PRS=$(echo $STATS_JSON | jq -r '.prs_opened')
          PRS_MERGED=$(echo $STATS_JSON | jq -r '.prs_merged')

          cat > report.md << EOF
          # ðŸ“Š Orchestro Weekly Stats

          **Week of $(date +%Y-%m-%d)**

          ## GitHub Activity
          - â­ **Total Stars**: $STARS
          - ðŸ”± **Total Forks**: $FORKS
          - ðŸ†• **New Issues**: $ISSUES
          - ðŸ”§ **New PRs**: $PRS
          - âœ… **Merged PRs**: $PRS_MERGED

          ## PyPI
          - ðŸ“¦ **Downloads (7 days)**: ${{ steps.pypi_stats.outputs.downloads }}

          ## Links
          - [GitHub Repo](https://github.com/${{ github.repository }})
          - [Documentation](https://github.com/${{ github.repository }}/tree/main/docs)
          - [Latest Release](https://github.com/${{ github.repository }}/releases/latest)

          ---

          Thanks to all our contributors and users! ðŸŽ‰

          **Want to contribute?** Check out [good first issues](https://github.com/${{ github.repository }}/labels/good%20first%20issue)
          EOF

          echo "report<<EOF" >> $GITHUB_OUTPUT
          cat report.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # 4. Post to Discord
      - name: Post to Discord
        if: vars.DISCORD_WEBHOOK != ''
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: "ðŸ“Š Weekly Stats Report"
          description: ${{ steps.report.outputs.report }}
          color: 0x0099ff
          username: "Orchestro Stats Bot"

      # 5. Create Issue Summary
      - name: Job Summary
        run: |
          cat report.md >> $GITHUB_STEP_SUMMARY
